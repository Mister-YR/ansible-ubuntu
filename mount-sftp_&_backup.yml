---
- hosts: all
  gather_facts: true
  become: true
  ignore_errors: true

  vars:
    hostname-ta4ki:

  tasks:
  - name: get hostanme to variable 'hostname-ta4ki'
    shell: echo $HOSTNAME
    register: hostname-ta4ki

  - name: add record to sftab
    lineinfile:
      path: "/etc/fstab"
      line: "192.168.168.13:/data/sf-awx-bcp-user/bcp-linux /mnt/sshftps fuse.sshfs defaults 0 0"
      
  - name: create directory for backup
    shell: 'mkdir /mnt/sshftps/'
    
  - name: mount sftp via shell *without reboot*
    shell: 'mount -av'

  - name: create baremetal backup via dd to /nmt/sshftps
    shell: sudo dd if=/dev/sda conv=sync,noerror bs=64K | gzip -c  > /mnt/sshftps/{{ hostname-ta4ki }}-{{ ansible_date }}.img.gz

  - name: unmount sftp after backup
    shell: 'umount /mnt/sshftps'
